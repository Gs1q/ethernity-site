<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Форум — Ethernity</title>
  <style>
    /* Сброс и базовые стили */
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f4f7fa;
      color: #333;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      background: #1d3557;
      color: #f1faee;
      padding: 15px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      box-shadow: 0 2px 5px rgba(0,0,0,0.15);
    }
    header img.logo {
      height: 40px;
      cursor: pointer;
      filter: drop-shadow(0 0 1px #fff);
    }
    .header-right button, .header-right .cta-btn {
      background: #457b9d;
      border: none;
      color: #f1faee;
      padding: 8px 15px;
      margin-left: 8px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.3s ease;
      user-select: none;
    }
    .header-right button:hover, .header-right .cta-btn:hover {
      background: #1d3557;
    }
    main {
      flex: 1;
      max-width: 900px;
      margin: 25px auto;
      width: 90%;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgb(0 0 0 / 0.1);
      padding: 25px 30px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      min-height: 400px;
    }
    h1, h2 {
      color: #1d3557;
      margin-bottom: 20px;
      font-weight: 700;
      letter-spacing: 0.05em;
    }
    /* Ошибки */
    .error {
      background: #e63946;
      color: white;
      padding: 8px 12px;
      border-radius: 5px;
      margin-bottom: 15px;
      font-weight: 600;
      animation: fadein 0.5s ease forwards;
    }
    .hidden {
      display: none !important;
    }
    /* Формы */
    input[type="text"], input[type="password"], textarea {
      width: 100%;
      padding: 10px 14px;
      margin-top: 6px;
      margin-bottom: 15px;
      border: 1.5px solid #a8dadc;
      border-radius: 6px;
      font-size: 16px;
      transition: border-color 0.3s ease;
      resize: vertical;
    }
    input[type="text"]:focus, input[type="password"]:focus, textarea:focus {
      border-color: #1d3557;
      outline: none;
      box-shadow: 0 0 6px #457b9daa;
    }
    button {
      font-weight: 600;
      font-size: 15px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      transition: background 0.3s ease;
      padding: 10px 18px;
      background: #457b9d;
      color: white;
      user-select: none;
    }
    button:hover:not(:disabled) {
      background: #1d3557;
    }
    button:disabled {
      background: #a8dadc;
      cursor: not-allowed;
    }

    /* Карточки тем и постов */
    .topic, .post {
      border: 1px solid #a8dadc;
      border-radius: 8px;
      padding: 14px 20px;
      margin-bottom: 15px;
      background: #f1faee;
      box-shadow: 0 2px 5px rgb(0 0 0 / 0.07);
      transition: box-shadow 0.3s ease;
      cursor: pointer;
      user-select: none;
    }
    .topic:hover, .post:hover {
      box-shadow: 0 5px 12px rgb(0 0 0 / 0.15);
    }
    .topic-header, .post-header {
      font-weight: 700;
      font-size: 17px;
      margin-bottom: 6px;
      color: #1d3557;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .topic-meta, .post-meta {
      font-size: 13px;
      color: #457b9d;
      font-weight: 600;
    }
    .post-content {
      white-space: pre-wrap;
      font-size: 15px;
      line-height: 1.4;
      margin-top: 8px;
      color: #333;
    }
    .btn-link {
      background: transparent;
      color: #457b9d;
      padding: 0;
      border: none;
      cursor: pointer;
      font-size: 14px;
      text-decoration: underline;
      margin-left: 10px;
    }
    .btn-link:hover {
      color: #1d3557;
    }
    .delete-post-btn {
      background: #e63946;
      margin-left: 10px;
      padding: 5px 10px;
      font-size: 13px;
      border-radius: 5px;
    }
    .delete-post-btn:hover {
      background: #b2222b;
    }

    /* Секция форм */
    #create-topic-section, #create-post-section {
      margin-top: 20px;
      margin-bottom: 30px;
      border-top: 2px solid #a8dadc;
      padding-top: 20px;
    }
    #create-topic-section textarea, #create-post-section textarea {
      min-height: 80px;
    }

    /* Кнопки возврата к списку тем */
    #back-to-topics-btn {
      background: #a8dadc;
      color: #1d3557;
      font-weight: 700;
      margin-bottom: 15px;
      align-self: flex-start;
    }
    #back-to-topics-btn:hover {
      background: #457b9d;
      color: white;
    }

    /* Анимация для ошибок */
    @keyframes fadein {
      from {opacity: 0;}
      to {opacity: 1;}
    }

  </style>
</head>
<body>
  <header>
    <img src="logo.png" alt="Ethernity Logo" class="logo" id="logo" />
    <div class="header-right">
      <button id="main-menu-btn" class="nav-btn">Главное меню</button>
      <button id="servers-btn" class="nav-btn">Список серверов</button>
      <button id="news-btn" class="nav-btn">Новости</button>
      <button id="discord-login" class="cta-btn">Войти через Discord</button>
    </div>
  </header>

  <main>
    <h1>Форум Ethernity</h1>

    <!-- Авторизация -->
    <section id="auth-section">
      <h2>Вход / Регистрация</h2>
      <div id="auth-error" class="error hidden"></div>
      <input type="text" id="username-input" placeholder="Имя пользователя" autocomplete="username" />
      <input type="password" id="password-input" placeholder="Пароль" autocomplete="current-password" />
      <div style="display:flex; gap:10px; flex-wrap: wrap;">
        <button id="login-btn" style="flex:1;">Войти</button>
        <button id="register-btn" style="flex:1;">Зарегистрироваться</button>
      </div>
    </section>

    <!-- Информация о текущем пользователе -->
    <section id="user-info" class="hidden">
      <p>Вы вошли как: <strong><span id="current-username"></span></strong> (<em><span id="user-role"></span></em>)</p>
      <button id="logout-btn">Выйти</button>
    </section>

    <!-- Список тем -->
    <section id="topics-section">
      <h2>Темы форума</h2>
      <div id="topics-list">
        <!-- Темы появятся тут -->
      </div>
      <section id="create-topic-section">
        <h3>Создать новую тему</h3>
        <div id="topic-error" class="error hidden"></div>
        <input type="text" id="topic-title-input" placeholder="Заголовок темы" maxlength="100" />
        <textarea id="topic-content-input" placeholder="Первое сообщение в теме..." maxlength="1000"></textarea>
        <button id="create-topic-btn">Создать тему</button>
      </section>
    </section>

    <!-- Просмотр сообщений в теме -->
    <section id="posts-section" class="hidden">
      <button id="back-to-topics-btn">&larr; Назад к темам</button>
      <h2 id="current-topic-title">Название темы</h2>
      <div id="posts-list">
        <!-- Посты темы -->
      </div>
      <section id="create-post-section" class="hidden">
        <h3>Ответить в теме</h3>
        <div id="post-error" class="error hidden"></div>
        <textarea id="post-content-input" placeholder="Напишите сообщение..." maxlength="1000"></textarea>
        <button id="create-post-btn">Опубликовать</button>
      </section>
    </section>
  </main>

  <footer>
    © 2025 Ethernity. Все права защищены.
  </footer>

  <script>
    // Навигация
    document.getElementById('main-menu-btn').addEventListener('click', () => window.location.href = 'index.html');
    document.getElementById('servers-btn').addEventListener('click', () => window.location.href = 'servers.html');
    document.getElementById('news-btn').addEventListener('click', () => window.location.href = 'news.html');
    document.getElementById('logo').addEventListener('click', () => window.location.href = 'index.html');

    // Секции
    const authSection = document.getElementById('auth-section');
    const userInfoSection = document.getElementById('user-info');
    const topicsSection = document.getElementById('topics-section');
    const postsSection = document.getElementById('posts-section');
    const createPostSection = document.getElementById('create-post-section');
    const currentUsernameElem = document.getElementById('current-username');
    const userRoleElem = document.getElementById('user-role');
    const authErrorElem = document.getElementById('auth-error');
    const postErrorElem = document.getElementById('post-error');
    const topicErrorElem = document.getElementById('topic-error');

    // Формы
    const usernameInput = document.getElementById('username-input');
    const passwordInput = document.getElementById('password-input');
    const topicTitleInput = document.getElementById('topic-title-input');
    const topicContentInput = document.getElementById('topic-content-input');
    const postContentInput = document.getElementById('post-content-input');

    // Элементы списков
    const topicsList = document.getElementById('topics-list');
    const postsList = document.getElementById('posts-list');
    const backToTopicsBtn = document.getElementById('back-to-topics-btn');
    const currentTopicTitleElem = document.getElementById('current-topic-title');

    // Текущие состояния
    let currentUser = null;  // {username, role}
    let currentTopicId = null;

    // ==== localStorage functions ====
    function getUsers() {
      return JSON.parse(localStorage.getItem('users') || '[]');
    }
    function saveUsers(users) {
      localStorage.setItem('users', JSON.stringify(users));
    }
    function getTopics() {
      return JSON.parse(localStorage.getItem('topics') || '[]');
    }
    function saveTopics(topics) {
      localStorage.setItem('topics', JSON.stringify(topics));
    }
    function getPosts() {
      return JSON.parse(localStorage.getItem('posts') || '[]');
    }
    function savePosts(posts) {
      localStorage.setItem('posts', JSON.stringify(posts));
    }
    function saveSession() {
      localStorage.setItem('currentUser', JSON.stringify(currentUser));
    }
    function loadSession() {
      const saved = localStorage.getItem('currentUser');
      if (saved) currentUser = JSON.parse(saved);
    }
    function clearSession() {
      localStorage.removeItem('currentUser');
      currentUser = null;
    }

    // ==== Escape HTML to prevent injection ====
    function escapeHTML(str) {
      return str.replace(/[&<>"']/g, m => ({
        '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;'
      })[m]);
    }

    // ==== UI updates ====

    function showError(elem, msg) {
      elem.textContent = msg;
      elem.classList.remove('hidden');
      setTimeout(() => elem.classList.add('hidden'), 4000);
    }

    function clearAuthInputs() {
      usernameInput.value = '';
      passwordInput.value = '';
    }

    function updateUIForUser() {
      if (currentUser) {
        authSection.classList.add('hidden');
        userInfoSection.classList.remove('hidden');
        topicsSection.classList.remove('hidden');
        currentUsernameElem.textContent = currentUser.username;
        userRoleElem.textContent = currentUser.role;
        if(currentTopicId !== null) createPostSection.classList.remove('hidden');
      } else {
        authSection.classList.remove('hidden');
        userInfoSection.classList.add('hidden');
        topicsSection.classList.remove('hidden');
        createPostSection.classList.add('hidden');
        currentTopicId = null;
        postsSection.classList.add('hidden');
      }
      renderTopics();
      if(currentTopicId !== null) renderPosts(currentTopicId);
    }

    // ==== Auth ====

    document.getElementById('register-btn').addEventListener('click', () => {
      authErrorElem.classList.add('hidden');
      const username = usernameInput.value.trim();
      const password = passwordInput.value;

      if(!username || !password) {
        showError(authErrorElem, 'Введите имя пользователя и пароль');
        return;
      }
      const users = getUsers();
      if(users.find(u => u.username.toLowerCase() === username.toLowerCase())) {
        showError(authErrorElem, 'Пользователь с таким именем уже существует');
        return;
      }
      users.push({ username, password, role: 'user' }); // все новые – user
      saveUsers(users);
      alert('Регистрация прошла успешно! Теперь войдите.');
      clearAuthInputs();
    });

    document.getElementById('login-btn').addEventListener('click', () => {
      authErrorElem.classList.add('hidden');
      const username = usernameInput.value.trim();
      const password = passwordInput.value;

      if(!username || !password) {
        showError(authErrorElem, 'Введите имя пользователя и пароль');
        return;
      }

      const users = getUsers();
      const user = users.find(u => u.username === username && u.password === password);
      if(!user) {
        showError(authErrorElem, 'Неверное имя пользователя или пароль');
        return;
      }

      currentUser = { username: user.username, role: user.role };
      saveSession();
      updateUIForUser();
      clearAuthInputs();
    });

    document.getElementById('logout-btn').addEventListener('click', () => {
      clearSession();
      updateUIForUser();
    });

    // ==== Темы ====

    // Рендер списка тем
    function renderTopics() {
      topicsList.innerHTML = '';
      const topics = getTopics();

      if(topics.length === 0) {
        topicsList.innerHTML = '<p>Пока нет тем. Создайте первую!</p>';
        return;
      }

      topics.forEach(topic => {
        const postsCount = getPosts().filter(p => p.topicId === topic.id).length;
        const div = document.createElement('div');
        div.className = 'topic';
        div.dataset.id = topic.id;
        div.tabIndex = 0;
        div.setAttribute('role', 'button');
        div.setAttribute('aria-pressed', 'false');

        div.innerHTML = `
          <div class="topic-header">${escapeHTML(topic.title)}</div>
          <div class="topic-meta">Создал <strong>${escapeHTML(topic.creator)}</strong> • ${postsCount} ${postsCount === 1 ? 'сообщение' : 'сообщений'}</div>
        `;

        div.onclick = () => openTopic(topic.id);
        div.onkeydown = e => {
          if(e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            openTopic(topic.id);
          }
        };

        topicsList.appendChild(div);
      });
    }

    // Создание темы
    document.getElementById('create-topic-btn').addEventListener('click', () => {
      topicErrorElem.classList.add('hidden');
      if(!currentUser) {
        showError(topicErrorElem, 'Вы должны войти, чтобы создавать темы');
        return;
      }
      const title = topicTitleInput.value.trim();
      const content = topicContentInput.value.trim();
      if(title.length < 3) {
        showError(topicErrorElem, 'Заголовок должен содержать минимум 3 символа');
        return;
      }
      if(content.length < 3) {
        showError(topicErrorElem, 'Сообщение должно содержать минимум 3 символа');
        return;
      }

      const topics = getTopics();
      const posts = getPosts();

      const newTopic = {
        id: Date.now(),
        title,
        creator: currentUser.username,
        createdAt: new Date().toISOString()
      };
      topics.push(newTopic);
      saveTopics(topics);

      posts.push({
        id: Date.now() + 1,
        topicId: newTopic.id,
        author: currentUser.username,
        content,
        createdAt: new Date().toISOString()
      });
      savePosts(posts);

      topicTitleInput.value = '';
      topicContentInput.value = '';

      renderTopics();
      openTopic(newTopic.id);
    });

    // ==== Просмотр и создание сообщений ====

    function openTopic(id) {
      currentTopicId = id;
      topicsSection.classList.add('hidden');
      postsSection.classList.remove('hidden');
      createPostSection.classList.remove('hidden');
      renderPosts(id);
      const topics = getTopics();
      const topic = topics.find(t => t.id === id);
      currentTopicTitleElem.textContent = topic ? topic.title : '';
    }

    backToTopicsBtn.addEventListener('click', () => {
      postsSection.classList.add('hidden');
      topicsSection.classList.remove('hidden');
      currentTopicId = null;
      postContentInput.value = '';
      postErrorElem.classList.add('hidden');
      createPostSection.classList.add('hidden');
    });

    // Рендер сообщений темы
    function renderPosts(topicId) {
      postsList.innerHTML = '';
      const posts = getPosts().filter(p => p.topicId === topicId);
      if(posts.length === 0) {
        postsList.innerHTML = '<p>В этой теме пока нет сообщений.</p>';
        return;
      }
      posts.forEach(post => {
        const div = document.createElement('div');
        div.className = 'post';

        let controls = '';
        // Если автор поста — текущий пользователь, покажем кнопку удаления
        if(currentUser && currentUser.username === post.author) {
          controls = `<button class="delete-post-btn" aria-label="Удалить сообщение">Удалить</button>`;
        }

        div.innerHTML = `
          <div class="post-header">
            <span><strong>${escapeHTML(post.author)}</strong></span>
            <span class="post-meta">${new Date(post.createdAt).toLocaleString('ru-RU')}</span>
            ${controls}
          </div>
          <div class="post-content">${escapeHTML(post.content)}</div>
        `;

        if(controls) {
          div.querySelector('.delete-post-btn').addEventListener('click', () => {
            if(confirm('Удалить это сообщение?')) {
              deletePost(post.id);
            }
          });
        }

        postsList.appendChild(div);
      });
    }

    // Создание сообщения в теме
    document.getElementById('create-post-btn').addEventListener('click', () => {
      postErrorElem.classList.add('hidden');
      if(!currentUser) {
        showError(postErrorElem, 'Вы должны войти, чтобы писать сообщения');
        return;
      }
      if(currentTopicId === null) {
        showError(postErrorElem, 'Ошибка: тема не выбрана');
        return;
      }
      const content = postContentInput.value.trim();
      if(content.length < 3) {
        showError(postErrorElem, 'Сообщение должно содержать минимум 3 символа');
        return;
      }
      const posts = getPosts();
      posts.push({
        id: Date.now(),
        topicId: currentTopicId,
        author: currentUser.username,
        content,
        createdAt: new Date().toISOString()
      });
      savePosts(posts);
      postContentInput.value = '';
      renderPosts(currentTopicId);
    });

    // Удаление сообщения
    function deletePost(postId) {
      let posts = getPosts();
      posts = posts.filter(p => p.id !== postId);
      savePosts(posts);
      renderPosts(currentTopicId);
    }

    // ==== Инициализация ====
    loadSession();
    updateUIForUser();

  </script>
</body>
</html>
