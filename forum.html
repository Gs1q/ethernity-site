<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–§–æ—Ä—É–º ‚Äî Ethernity</title>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    :root {
      --bg: #1b1e26; --fg: #cfd2da;
      --panel: #16181f; --border: #2a2e38;
      --accent: #4a90e2; --danger: #e74c3c;
      --muted: #8a8e9f; --input-bg: #1f2129;
    }
    [data-theme="light"] {
      --bg: #f5f6fa; --fg: #333;
      --panel: #fff; --border: #ccc;
      --accent: #4a90e2; --danger: #e74c3c;
      --muted: #666; --input-bg: #fff;
    }
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--fg);
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    header, footer {
      background: var(--panel);
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    main {
      flex: 1;
      max-width: 900px;
      margin: 20px auto;
      padding: 0 15px;
      width: 100%;
    }
    #theme-toggle {
      background: none;
      border: none;
      color: var(--fg);
      cursor: pointer;
      font-size: 1.2rem;
    }
    .nav {
      display: flex;
      gap: 12px;
      margin: 20px 0;
    }
    .nav button {
      padding: 8px 14px;
      border: 1px solid var(--border);
      background: var(--panel);
      color: var(--fg);
      border-radius: 4px;
      cursor: pointer;
    }
    .nav button.active {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
    }
    #search-input {
      width: 100%;
      padding: 10px;
      margin-bottom: 20px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--fg);
    }
    #search-input::placeholder {
      color: var(--muted);
    }
    .topic, .post {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 16px;
      margin-bottom: 12px;
    }
    .topic:hover, .post:hover {
      box-shadow: 0 0 5px var(--border);
    }
    .topic-title {
      font-size: 1.2rem;
      color: var(--accent);
      cursor: pointer;
    }
    .meta {
      font-size: 0.9rem;
      color: var(--muted);
      margin-top: 8px;
      line-height: 1.4;
    }
    .actions {
      margin-top: 8px;
    }
    .actions button {
      background: none;
      border: none;
      color: var(--accent);
      cursor: pointer;
      margin-right: 8px;
      font-size: 0.9rem;
    }
    .actions button.delete {
      color: var(--danger);
    }
    .form {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 16px;
      margin-bottom: 24px;
    }
    .form input, .form select, .form textarea {
      width: 100%;
      padding: 8px;
      margin-bottom: 12px;
      background: var(--input-bg);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--fg);
      box-sizing: border-box;
    }
    .btn-primary {
      background: var(--accent);
      color: white;
      padding: 10px 18px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 600;
    }
    .btn-secondary {
      background: var(--panel);
      color: var(--fg);
      padding: 8px 14px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .like {
      color: var(--accent);
      font-weight: 600;
      cursor: pointer;
      user-select: none;
    }
    .like.liked {
      color: var(--danger);
    }
    .post-att img {
      max-width: 200px;
      margin-top: 8px;
      border-radius: 4px;
    }
    .error {
      color: var(--danger);
      background: rgba(231, 76, 60, 0.1);
      border: 1px solid var(--danger);
      padding: 8px 12px;
      border-radius: 5px;
      margin-bottom: 15px;
      font-weight: 600;
    }
    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <header>
    <div>–§–æ—Ä—É–º Ethernity</div>
    <button id="theme-toggle">üåì</button>
  </header>
  <main>
    <nav class="nav">
      <button id="nav-topics" class="active">–¢–µ–º—ã</button>
      <button id="nav-create-topic">–°–æ–∑–¥–∞—Ç—å —Ç–µ–º—É</button>
    </nav>

    <input id="search-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ —Ç–µ–º–∞–º –∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º‚Ä¶" />

    <section id="topics-section"></section>

    <section id="create-topic-section" class="form hidden">
      <h3>–°–æ–∑–¥–∞—Ç—å —Ç–µ–º—É</h3>
      <input id="topic-title" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–µ–º—ã" maxlength="100" />
      <select id="topic-category">
        <option>–û–±—â–∏–µ</option>
        <option>–ò–≥—Ä—ã</option>
        <option>–¢–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫–∞</option>
        <option>–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è</option>
      </select>
      <input id="topic-tags" placeholder="–¢–µ–≥–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)" />
      <textarea id="topic-desc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ —Ç–µ–º—ã (Markdown)"></textarea>
      <button id="submit-topic" class="btn-primary">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å —Ç–µ–º—É</button>
      <button id="cancel-topic" class="btn-secondary">–û—Ç–º–µ–Ω–∞</button>
    </section>

    <section id="topic-view" class="hidden">
      <button id="back-topics" class="btn-secondary">‚Üê –ù–∞–∑–∞–¥ –∫ —Ç–µ–º–∞–º</button>
      <h2 id="view-title"></h2>
      <div id="view-meta" class="meta"></div>
      <div id="view-desc" class="meta"></div>
      <button id="subscribe-btn" class="btn-secondary">–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è</button>
      <div id="posts-section"></div>
      <section id="post-form" class="form">
        <h3>–û—Ç–≤–µ—Ç–∏—Ç—å</h3>
        <textarea id="post-content" placeholder="–í–∞—à –æ—Ç–≤–µ—Ç (Markdown)"></textarea>
        <input type="file" id="post-attach" accept="image/*" />
        <button id="submit-post" class="btn-primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        <button id="cancel-post" class="btn-secondary">–û—Ç–º–µ–Ω–∞</button>
      </section>
    </section>
  </main>
  <footer style="text-align:center; padding:10px;">¬©‚ÄØ2025 Ethernity</footer>

  <script>
  (() => {
    // === State & Storage ===
    const LS = {
      USERS: 'forum_users',
      TOPICS: 'forum_topics',
      POSTS: 'forum_posts',
      SUBS: 'forum_subs',
      SESSION: 'forum_session',
      THEME: 'forum_theme'
    };
    let users = JSON.parse(localStorage.getItem(LS.USERS) || '[]');
    let topics = JSON.parse(localStorage.getItem(LS.TOPICS) || '[]');
    let posts = JSON.parse(localStorage.getItem(LS.POSTS) || '[]');
    let subs = JSON.parse(localStorage.getItem(LS.SUBS) || '{}');
    let currentUser = JSON.parse(localStorage.getItem(LS.SESSION)) || null;
    let currentTopic = null;
    let tPage = 1, pPage = 1;
    const PAGE = 5;
    const guest = '–ì–æ—Å—Ç—å';

    // === Helpers ===
    const save = () => {
      localStorage.setItem(LS.USERS, JSON.stringify(users));
      localStorage.setItem(LS.TOPICS, JSON.stringify(topics));
      localStorage.setItem(LS.POSTS, JSON.stringify(posts));
      localStorage.setItem(LS.SUBS, JSON.stringify(subs));
      localStorage.setItem(LS.SESSION, JSON.stringify(currentUser));
    };
    const paginate = (arr, n) => arr.slice((n-1)*PAGE, n*PAGE);
    const now = () => new Date().toISOString();
    const esc = s => s ? s.replace(/[&<>"']/g, m => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    })[m]) : '';
    const getRank = u => {
      const count = posts.filter(p=>p.author===u).length;
      if(count>=50) return '–í–µ—Ç–µ—Ä–∞–Ω';
      if(count>=11) return '–ê–∫—Ç–∏–≤–Ω—ã–π';
      return '–ù–æ–≤–∏—á–æ–∫';
    };

    // === Init admin ===
    const initAdmin = () => {
      if(!users.find(u=>u.username==='Gs1q')){
        users.push({ username:'Gs1q', password:'123456789', description:'–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä', role:'admin', avatar:'' });
        save();
      }
    };

    // === Theme toggle ===
    const html = document.documentElement;
    const themeBtn = document.getElementById('theme-toggle');
    let theme = localStorage.getItem(LS.THEME) || 'dark';
    html.setAttribute('data-theme', theme);
    themeBtn.textContent = theme==='dark'?'üåû':'üåô';
    themeBtn.onclick = () => {
      theme = theme==='dark'?'light':'dark';
      html.setAttribute('data-theme', theme);
      localStorage.setItem(LS.THEME, theme);
      themeBtn.textContent = theme==='dark'?'üåû':'üåô';
    };

    // === Render themes list ===
    const renderTopics = (reset=false) => {
      if(reset) tPage=1;
      const term = document.getElementById('search-input').value.toLowerCase();
      const filtered = topics.filter(t=>
        t.title.toLowerCase().includes(term) ||
        t.desc.toLowerCase().includes(term) ||
        t.tags.find(tag=>tag.toLowerCase().includes(term))
      );
      const slice = paginate(filtered, tPage);
      const cont = document.getElementById('topics-section');
      cont.innerHTML = '';
      slice.forEach(t=>{
        const div = document.createElement('div');
        div.className='topic';
        div.innerHTML = `
          <div><span class="topic-title">${esc(t.title)}</span></div>
          <div class="meta">–ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${esc(t.category)} ‚Ä¢ –ê–≤—Ç–æ—Ä: ${esc(t.author)} ‚Ä¢ –†–∞–Ω–≥: ${esc(getRank(t.author))}</div>
        `;
        div.onclick = () => openTopic(t.id);
        cont.appendChild(div);
      });
      if(slice.length===PAGE){
        const btn = document.createElement('button');
        btn.textContent = '–ü–æ–∫–∞–∑–∞—Ç—å –µ—â—ë‚Ä¶';
        btn.className = 'btn-secondary';
        btn.onclick = ()=>{ tPage++; renderTopics(); };
        cont.appendChild(btn);
      }
    };

    // === Open topic view ===
    const openTopic = id => {
      currentTopic = topics.find(t=>t.id===id);
      if(!currentTopic) return alert('–¢–µ–º–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
      document.getElementById('view-title').textContent = currentTopic.title;
      document.getElementById('view-meta').textContent = `–ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${currentTopic.category} ‚Ä¢ –ê–≤—Ç–æ—Ä: ${currentTopic.author} (${getRank(currentTopic.author)})`;
      document.getElementById('view-desc').innerHTML = marked.parse(currentTopic.desc);
      renderPosts(true);
      const subArr = subs[currentTopic.id] || [];
      document.getElementById('subscribe-btn').textContent = subArr.includes(currentUser?.username || guest) ? '–û—Ç–ø–∏—Å–∞—Ç—å—Å—è' : '–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è';
      show('view');
    };

    // === Render posts ===
    const renderPosts = (reset=false) => {
      if(reset) pPage=1;
      const arr = posts.filter(p=>p.topicId===currentTopic.id);
      const slice = paginate(arr, pPage);
      const cont = document.getElementById('posts-section');
      cont.innerHTML = '';
      slice.forEach(p=>{
        const liked = p.likes && p.likes.includes(currentUser?.username || guest);
        const likesCount = p.likes ? p.likes.length : 0;
        const div = document.createElement('div');
        div.className='post';
        div.innerHTML = `
          <div class="meta"><strong>${esc(p.author)}</strong> (${getRank(p.author)}) ‚Ä¢ ${new Date(p.date).toLocaleString()}</div>
          <div>${marked.parse(p.content)}</div>
          ${p.att?`<div class="post-att"><img src="${p.att}"></div>`:''}
          <div class="actions">
            <button class="like ${liked?'liked':''}">‚ù§ ${likesCount}</button>
            ${(currentUser?.username===p.author || currentUser?.role!=='user')?'<button class="delete">–£–¥–∞–ª–∏—Ç—å</button>':''}
          </div>
        `;
        div.querySelector('.actions .like').onclick = () => {
          p.likes = p.likes || [];
          const idx = p.likes.indexOf(currentUser?.username||guest);
          if(idx>=0) p.likes.splice(idx,1); else p.likes.push(currentUser?.username||guest);
          save(); renderPosts(reset);
        };
        const delBtn = div.querySelector('.actions .delete');
        if(delBtn){
          delBtn.onclick = () => {
            if(confirm('–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?')){
              posts = posts.filter(x=>x.id!==p.id);
              save(); renderPosts(reset);
            }
          };
        }
        cont.appendChild(div);
      });
      if(slice.length===PAGE){
        const more = document.createElement('button');
        more.textContent = '–ü–æ–∫–∞–∑–∞—Ç—å –µ—â—ë‚Ä¶';
        more.className = 'btn-secondary';
        more.onclick = () => { pPage++; renderPosts(); };
        cont.appendChild(more);
      }
    };

    // === Navigation and sections ===
    const sections = {
      topics: document.getElementById('topics-section'),
      create: document.getElementById('create-topic-section'),
      view: document.getElementById('topic-view')
    };
    const show = key => {
      Object.keys(sections).forEach(k=>sections[k].classList.toggle('hidden', k!==key));
      document.querySelectorAll('.nav button').forEach(b=>b.classList.toggle('active', b.id==='nav-'+key+'s'));
    };

    // === Subscribe ===
    document.getElementById('subscribe-btn').onclick = ()=>{
      const arr = subs[currentTopic.id] || [];
      const who = currentUser?.username || guest;
      const i = arr.indexOf(who);
      if(i>=0) arr.splice(i,1); else arr.push(who);
      subs[currentTopic.id] = arr;
      save();
      document.getElementById('subscribe-btn').textContent = arr.includes(who) ? '–û—Ç–ø–∏—Å–∞—Ç—å—Å—è' : '–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è';
    };

    // === Create topic ===
    document.getElementById('submit-topic').onclick = ()=>{
      const title = document.getElementById('topic-title').value.trim();
      const category = document.getElementById('topic-category').value;
      const tags = document.getElementById('topic-tags').value.split(',').map(s=>s.trim()).filter(s=>s);
      const desc = document.getElementById('topic-desc').value.trim();
      if(title.length<3 || desc.length<3) return alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏');
      const id = 't_'+Date.now();
      topics.unshift({ id, title, category, tags, desc, author: currentUser?.username||guest, date: now() });
      save();
      document.getElementById('topic-title').value='';
      document.getElementById('topic-tags').value='';
      document.getElementById('topic-desc').value='';
      openTopic(id);
    };

    document.getElementById('cancel-topic').onclick = ()=>show('topics');
    document.getElementById('back-topics').onclick = ()=>show('topics');

    // === Create post ===
    document.getElementById('submit-post').onclick = ()=>{
      const txt = document.getElementById('post-content').value.trim();
      const file = document.getElementById('post-attach').files[0];
      if(!txt) return alert('–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ');
      const rdr = new FileReader();
      rdr.onload = ()=>{
        const att = rdr.result;
        const p = { id:'p_'+Date.now(), topicId:currentTopic.id, author:currentUser?.username||guest, content:txt, att, date: now(), likes:[] };
        posts.unshift(p);
        save();
        renderPosts(true);
        if(subs[currentTopic.id]){
          subs[currentTopic.id].filter(u=>u!==currentUser?.username).forEach(u=>{
            alert(`üîî ${u}, –Ω–æ–≤–∞—è –∑–∞–ø–∏—Å—å –≤ —Ç–µ–º–µ "${currentTopic.title}"`);
          });
        }
      };
      if(file) rdr.readAsDataURL(file); else rdr.onload();
    };

    document.getElementById('cancel-post').onclick = ()=>document.getElementById('post-content').value='';

    // === Register/Login ===
    const checkPwd = (u,p) => users.find(x=>x.username===u && x.password===p);
    document.getElementById('register-btn').onclick = ()=>{
      const u = prompt('–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω');
      const p = prompt('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å');
      if(!u||!p) return;
      if(users.find(x=>x.username===u)) return alert('–¢–∞–∫–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –µ—Å—Ç—å');
      users.push({ username:u, password:p, description:'', role:'user', avatar:'' });
      save();
      alert('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞');
    };
    document.getElementById('nav-create-topic').onclick = ()=>{
      if(!currentUser) return alert('–í–æ–π–¥–∏—Ç–µ –ø–µ—Ä–≤—ã–º');
      show('create');
    };
    document.getElementById('nav-topics').onclick = ()=>show('topics');
    document.getElementById('search-input').oninput = ()=>renderTopics(true);

    document.getElementById('login-btn').onclick = ()=>{
      const u = prompt('–õ–æ–≥–∏–Ω');
      const p = prompt('–ü–∞—Ä–æ–ª—å');
      const user = checkPwd(u,p);
      if(user){
        currentUser = user;
        save();
        renderTopics(true);
      } else alert('–ù–µ–≤–µ—Ä–Ω—ã–µ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ');
    };
    document.getElementById('logout-btn').onclick = ()=>{
      currentUser = null;
      save();
      renderTopics(true);
    };

    // === Init ===
    const nowDate = () => new Date().toISOString();
    const now = nowDate;
    initAdmin();
    renderTopics();
    show('topics');
  })();
  </script>
</body>
</html>
