<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Форум — Ethernity</title>
  <style>
    /* стили не изменялись, оставить как есть */
  </style>
</head>
<body>

<header>
  <img src="logo.png" alt="Ethernity Logo" class="logo" />
  <div class="header-buttons">
    <button id="main-menu-btn">Главное меню</button>
    <button id="servers-btn">Список серверов</button>
    <button id="news-btn">Новости</button>
  </div>
</header>

<main>
  <!-- Список тем -->
  <section id="topics-section">
    <h2>Темы для обсуждения</h2>
    <input type="text" id="search-input" placeholder="Поиск по темам..." style="width: 100%; padding: 8px; margin-bottom: 15px; border-radius: 6px; border: 1px solid #ccc;" />
    <div id="topics-list">
      <!-- Темы появятся здесь -->
    </div>
  </section>

  <!-- Авторизация и профиль -->
  <aside id="auth-container">
    <!-- Авторизация -->
    <section id="auth-section">
      <h2>Авторизация</h2>
      <div id="auth-error" class="error hidden"></div>
      <input type="text" id="login-input" placeholder="Логин" autocomplete="username" />
      <input type="password" id="password-input" placeholder="Пароль" autocomplete="current-password" />
      <button id="login-btn">Войти</button>
      <button id="register-btn">Регистрация</button>
    </section>

    <!-- Информация о пользователе -->
    <section id="user-info" class="hidden">
      <div class="avatar" id="user-avatar">U</div>
      <div id="user-name" style="font-weight:700; font-size:18px; margin-top:8px;"></div>
      <div class="role-tag" id="user-role"></div>
      <button id="logout-btn" style="margin-top: 20px;">Выйти</button>
    </section>
  </aside>
</main>

<!-- Модальное окно -->
<div id="topic-view" class="hidden" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;justify-content:center;align-items:flex-start;padding:30px;box-sizing:border-box;overflow-y:auto;z-index:9999;">
  <div style="background:white;border-radius:10px;width:100%;max-width:800px;max-height:90vh;overflow-y:auto;padding:25px 30px;box-sizing:border-box;position:relative;">
    <button id="close-topic-view" style="position:absolute;top:15px;right:15px;background:#e74c3c;border:none;color:white;font-weight:700;font-size:18px;width:32px;height:32px;border-radius:50%;cursor:pointer;line-height:0;">×</button>
    <h2 id="topic-view-title" style="margin-top:0; user-select:none;"></h2>
    <button id="back-to-topics-btn">← Назад к темам</button>

    <div id="posts-list"></div>

    <div id="create-post-section" class="hidden">
      <h3>Добавить сообщение</h3>
      <textarea id="post-text" rows="4" placeholder="Ваше сообщение..."></textarea>
      <button id="add-post-btn">Отправить</button>
      <div id="post-error" class="error hidden"></div>
    </div>
  </div>
</div>

<!-- Создание темы -->
<section id="create-topic-section" style="width:100%;max-width:1000px;margin-bottom:40px;padding:0 20px;box-sizing:border-box;">
  <h2>Создать новую тему</h2>
  <input type="text" id="new-topic-title" placeholder="Название темы" style="font-size:16px; padding:10px; border-radius:6px; border:1px solid #ccc; width: 100%; box-sizing: border-box;" />
  <button id="create-topic-btn" style="margin-top: 10px; max-width: 200px;">Создать тему</button>
  <div id="create-topic-error" class="error hidden" style="max-width: 300px;"></div>
</section>

<script>
const users = JSON.parse(localStorage.getItem("users") || "{}");
let currentUser = JSON.parse(localStorage.getItem("currentUser") || "null");
let topics = JSON.parse(localStorage.getItem("topics") || "[]");

function saveState() {
  localStorage.setItem("users", JSON.stringify(users));
  localStorage.setItem("topics", JSON.stringify(topics));
  localStorage.setItem("currentUser", JSON.stringify(currentUser));
}

function renderUserInfo() {
  const authSection = document.getElementById("auth-section");
  const userInfo = document.getElementById("user-info");
  if (currentUser) {
    document.getElementById("user-name").textContent = currentUser.username;
    document.getElementById("user-avatar").textContent = currentUser.username[0].toUpperCase();
    document.getElementById("user-role").textContent = currentUser.role;
    authSection.classList.add("hidden");
    userInfo.classList.remove("hidden");
  } else {
    authSection.classList.remove("hidden");
    userInfo.classList.add("hidden");
  }
}

function renderTopics() {
  const list = document.getElementById("topics-list");
  const query = document.getElementById("search-input").value.toLowerCase();
  list.innerHTML = "";
  topics.filter(t => t.title.toLowerCase().includes(query)).forEach(topic => {
    const div = document.createElement("div");
    div.className = "topic";
    div.textContent = topic.title;
    div.onclick = () => openTopic(topic);
    list.appendChild(div);
  });
}

function openTopic(topic) {
  document.getElementById("topic-view").classList.remove("hidden");
  document.getElementById("topic-view-title").textContent = topic.title;
  document.getElementById("create-post-section").classList.toggle("hidden", !currentUser);

  const postList = document.getElementById("posts-list");
  postList.innerHTML = "";
  topic.posts.forEach(post => {
    const div = document.createElement("div");
    div.className = "post";
    div.innerHTML = `<b>${post.author}</b>:<br>${post.text}`;
    postList.appendChild(div);
  });

  document.getElementById("add-post-btn").onclick = () => {
    const text = document.getElementById("post-text").value.trim();
    if (text.length < 1) return;
    topic.posts.push({ author: currentUser.username, text });
    document.getElementById("post-text").value = "";
    saveState();
    openTopic(topic);
  };
}

document.getElementById("close-topic-view").onclick = () => {
  document.getElementById("topic-view").classList.add("hidden");
};

document.getElementById("search-input").oninput = renderTopics;
document.getElementById("create-topic-btn").onclick = () => {
  const title = document.getElementById("new-topic-title").value.trim();
  if (!title || !currentUser) return;
  topics.unshift({ title, posts: [] });
  document.getElementById("new-topic-title").value = "";
  saveState();
  renderTopics();
};
document.getElementById("login-btn").onclick = () => {
  const login = document.getElementById("login-input").value.trim();
  const pass = document.getElementById("password-input").value.trim();
  const user = users[login];
  if (user && user.password === pass) {
    currentUser = { username: login, role: user.role };
    saveState();
    renderUserInfo();
  } else {
    alert("Неверный логин или пароль");
  }
};
document.getElementById("register-btn").onclick = () => {
  const login = document.getElementById("login-input").value.trim();
  const pass = document.getElementById("password-input").value.trim();
  if (users[login]) return alert("Пользователь уже существует");
  users[login] = { password: pass, role: login === "admin" ? "admin" : "user" };
  currentUser = { username: login, role: users[login].role };
  saveState();
  renderUserInfo();
};
document.getElementById("logout-btn").onclick = () => {
  currentUser = null;
  saveState();
  renderUserInfo();
};

renderUserInfo();
renderTopics();
</script>

</body>
</html>
