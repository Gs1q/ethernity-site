<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Форум — Ethernity</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f0f2f5;
      margin: 0; padding: 0;
      color: #333;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      background-color: #282c34;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    header img.logo {
      height: 40px;
    }
    .header-right button {
      margin-left: 12px;
      background: #4a90e2;
      border: none;
      padding: 8px 14px;
      color: white;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.3s;
      font-weight: 600;
      font-size: 14px;
    }
    .header-right button:hover {
      background: #357ABD;
    }
    main {
      flex: 1;
      max-width: 900px;
      margin: 20px auto;
      background: white;
      border-radius: 8px;
      padding: 25px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }
    h1, h2 {
      margin-top: 0;
      color: #222;
    }
    /* Errors */
    .error {
      color: #d93025;
      margin-bottom: 15px;
      font-weight: 600;
      background: #fddede;
      border: 1px solid #d93025;
      padding: 8px 12px;
      border-radius: 5px;
    }
    .hidden {
      display: none !important;
    }
    /* Inputs and buttons */
    input[type="text"], input[type="password"], input[type="email"], textarea {
      width: 100%;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 15px;
      margin-bottom: 15px;
      resize: vertical;
      font-family: inherit;
      box-sizing: border-box;
      transition: border-color 0.2s;
    }
    input[type="text"]:focus, input[type="password"]:focus, textarea:focus {
      border-color: #4a90e2;
      outline: none;
    }
    button {
      background: #4a90e2;
      color: white;
      border: none;
      padding: 10px 18px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 15px;
      transition: background 0.3s;
    }
    button:hover:not(:disabled) {
      background: #357ABD;
    }
    button:disabled {
      background: #a0c4f7;
      cursor: not-allowed;
    }
    /* Posts & Topics */
    .topic, .post {
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 15px;
      margin-bottom: 15px;
      background: #fafafa;
      box-shadow: 0 1px 4px rgba(0,0,0,0.05);
    }
    .topic-header, .post-header {
      font-weight: 700;
      margin-bottom: 8px;
      color: #2c3e50;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .post-content {
      white-space: pre-wrap;
      line-height: 1.4;
      font-size: 15px;
      color: #444;
    }
    .topic-title {
      font-size: 18px;
      cursor: pointer;
      color: #3366cc;
      text-decoration: underline;
    }
    .topic-title:hover {
      color: #274b8c;
    }
    .info-text {
      color: #666;
      font-size: 14px;
      margin-top: 0;
      margin-bottom: 12px;
    }
    .btn-small {
      background: #e74c3c;
      padding: 5px 10px;
      font-size: 13px;
      border-radius: 4px;
    }
    .btn-small:hover {
      background: #c0392b;
    }
    /* Layout for auth & content */
    #auth-section, #user-info, #create-topic-section, #create-post-section {
      margin-bottom: 30px;
    }
    /* Scrollable posts */
    #posts-list {
      max-height: 400px;
      overflow-y: auto;
      padding-right: 5px;
    }
    /* Responsive */
    @media (max-width: 600px) {
      main {
        margin: 10px;
        padding: 15px;
      }
      .header-right button {
        padding: 6px 10px;
        font-size: 13px;
      }
    }
  </style>
</head>
<body>
  <header>
    <img src="logo.png" alt="Ethernity Logo" class="logo" />
    <div class="header-right">
      <button id="main-menu-btn">Главное меню</button>
      <button id="servers-btn">Список серверов</button>
      <button id="news-btn">Новости</button>
      <button id="discord-login" class="cta-btn">Войти через Discord</button>
    </div>
  </header>

  <main>
    <h1>Форум Ethernity</h1>

    <!-- Авторизация -->
    <section id="auth-section">
      <h2>Вход / Регистрация</h2>
      <div id="auth-error" class="error hidden"></div>
      <input type="text" id="username-input" placeholder="Имя пользователя" autocomplete="username" />
      <input type="password" id="password-input" placeholder="Пароль" autocomplete="current-password" />
      <div style="display: flex; gap: 10px;">
        <button id="login-btn" style="flex:1;">Войти</button>
        <button id="register-btn" style="flex:1;">Зарегистрироваться</button>
      </div>
    </section>

    <!-- Информация о текущем пользователе -->
    <section id="user-info" class="hidden">
      <p>Вы вошли как: <strong id="current-username"></strong> (<span id="user-role"></span>)</p>
      <button id="logout-btn">Выйти</button>
    </section>

    <!-- Создание темы -->
    <section id="create-topic-section" class="hidden">
      <h2>Создать новую тему</h2>
      <div id="topic-error" class="error hidden"></div>
      <input type="text" id="topic-title-input" placeholder="Заголовок темы" maxlength="100" />
      <textarea id="topic-content-input" rows="4" placeholder="Первое сообщение темы..." maxlength="2000"></textarea>
      <button id="create-topic-btn">Опубликовать тему</button>
    </section>

    <!-- Список тем -->
    <section id="topics-section">
      <h2>Темы для обсуждения</h2>
      <div id="topics-list">
        <!-- Темы будут тут -->
      </div>
    </section>

    <!-- Просмотр сообщений темы -->
    <section id="view-topic-section" class="hidden">
      <button id="back-to-topics-btn" style="margin-bottom: 15px;">← Назад к темам</button>
      <h2 id="view-topic-title"></h2>
      <div id="posts-list" style="margin-bottom: 20px;">
        <!-- Посты будут здесь -->
      </div>

      <!-- Создание сообщения в теме -->
      <section id="create-post-section" class="hidden">
        <h3>Написать сообщение</h3>
        <div id="post-error" class="error hidden"></div>
        <textarea id="post-content-input" rows="3" placeholder="Ваше сообщение..." maxlength="2000"></textarea>
        <button id="create-post-btn">Отправить</button>
      </section>
    </section>

  </main>

  <footer style="text-align:center; padding: 15px; font-size: 14px; color: #777;">
    © 2025 Ethernity. Все права защищены.
  </footer>

  <script>
    // Навигация по сайту
    document.getElementById('main-menu-btn').onclick = () => window.location.href = 'index.html';
    document.getElementById('servers-btn').onclick = () => window.location.href = 'servers.html';
    document.getElementById('news-btn').onclick = () => window.location.href = 'news.html';

    // Константы для localStorage ключей
    const STORAGE_KEYS = {
      USERS: 'ethernity_forum_users',
      TOPICS: 'ethernity_forum_topics',
      POSTS: 'ethernity_forum_posts',
      SESSION: 'ethernity_forum_session'
    };

    // Глобальные переменные
    let currentUser = null; // {username, role}
    let topics = [];
    let posts = [];
    let currentTopicId = null;

    // === Утилиты ===

    function escapeHTML(str) {
      if (!str) return '';
      return str.replace(/[&<>"']/g, m => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;'
      })[m]);
    }

    function saveUsers(users) {
      localStorage.setItem(STORAGE_KEYS.USERS, JSON.stringify(users));
    }

    function getUsers() {
      return JSON.parse(localStorage.getItem(STORAGE_KEYS.USERS) || '[]');
    }

    function saveTopics(data) {
      localStorage.setItem(STORAGE_KEYS.TOPICS, JSON.stringify(data));
    }

    function getTopics() {
      return JSON.parse(localStorage.getItem(STORAGE_KEYS.TOPICS) || '[]');
    }

    function savePosts(data) {
      localStorage.setItem(STORAGE_KEYS.POSTS, JSON.stringify(data));
    }

    function getPosts() {
      return JSON.parse(localStorage.getItem(STORAGE_KEYS.POSTS) || '[]');
    }

    function saveSession(user) {
      localStorage.setItem(STORAGE_KEYS.SESSION, JSON.stringify(user));
    }

    function loadSession() {
      const saved = localStorage.getItem(STORAGE_KEYS.SESSION);
      if(saved) {
        return JSON.parse(saved);
      }
      return null;
    }

    function clearSession() {
      localStorage.removeItem(STORAGE_KEYS.SESSION);
    }

    // === Пользователи ===

    function addUser(username, password, email = '', role = 'user') {
      const users = getUsers();
      if(users.find(u => u.username.toLowerCase() === username.toLowerCase())) {
        return false;
      }
      users.push({ username, password, email, role });
      saveUsers(users);
      return true;
    }

    function checkPassword(username, password) {
      const users = getUsers();
      const user = users.find(u => u.username.toLowerCase() === username.toLowerCase());
      if(!user) return false;
      return user.password === password;
    }

    // === Инициализация админа при первой загрузке ===

    function initAdmin() {
      const users = getUsers();
      if(users.length === 0 || !users.find(u => u.username === 'Gs1q')) {
        addUser('Gs1q', '123456789', '', 'admin');
      }
    }

    // === Отрисовка ===

    // Обновить UI в зависимости от пользователя и состояния
    function updateUI() {
      if(currentUser) {
        document.getElementById('auth-section').classList.add('hidden');
        document.getElementById('user-info').classList.remove('hidden');
        document.getElementById('current-username').textContent = currentUser.username;
        document.getElementById('user-role').textContent = currentUser.role;
        document.getElementById('create-topic-section').classList.remove('hidden');
        // Скрыть просмотр темы и постов, если не выбран топик
        if(currentTopicId) {
          showTopic(currentTopicId);
        } else {
          showTopicsList();
        }
      } else {
        document.getElementById('auth-section').classList.remove('hidden');
        document.getElementById('user-info').classList.add('hidden');
        document.getElementById('create-topic-section').classList.add('hidden');
        document.getElementById('view-topic-section').classList.add('hidden');
        document.getElementById('topics-section').classList.remove('hidden');
      }
      renderTopics();
    }

    // Отрисовать список тем
    function renderTopics() {
      const container = document.getElementById('topics-list');
      topics = getTopics();
      if(topics.length === 0) {
        container.innerHTML = '<p>Тем пока нет. Создайте первую!</p>';
        return;
      }
      container.innerHTML = '';
      topics.forEach(topic => {
        const div = document.createElement('div');
        div.classList.add('topic');
        div.dataset.id = topic.id;
        div.innerHTML = `
          <div class="topic-header">
            <span class="topic-title" title="Перейти к теме">${escapeHTML(topic.title)}</span>
            <span style="font-size:13px; color:#777;">Автор: ${escapeHTML(topic.author)} | ${new Date(topic.date).toLocaleString()}</span>
          </div>
        `;
        container.appendChild(div);

        div.querySelector('.topic-title').onclick = () => {
          showTopic(topic.id);
        }
      });
    }

    // Отрисовать сообщения выбранной темы
    function renderPosts(topicId) {
      posts = getPosts().filter(p => p.topicId === topicId);
      const container = document.getElementById('posts-list');
      if(posts.length === 0) {
        container.innerHTML = '<p>Постов в этой теме пока нет. Станьте первым!</p>';
        return;
      }
      container.innerHTML = '';
      posts.forEach(post => {
        const div = document.createElement('div');
        div.classList.add('post');
        div.innerHTML = `
          <div class="post-header">
            <span><strong>${escapeHTML(post.author)}</strong> написал:</span>
            <span style="font-size:13px; color:#777;">${new Date(post.date).toLocaleString()}</span>
          </div>
          <div class="post-content">${escapeHTML(post.content)}</div>
        `;
        container.appendChild(div);
      });
    }

    // Показать список тем
    function showTopicsList() {
      currentTopicId = null;
      document.getElementById('view-topic-section').classList.add('hidden');
      document.getElementById('topics-section').classList.remove('hidden');
      document.getElementById('create-post-section').classList.add('hidden');
      document.getElementById('topic-error').classList.add('hidden');
      renderTopics();
    }

    // Показать одну тему и её сообщения
    function showTopic(topicId) {
      currentTopicId = topicId;
      document.getElementById('topics-section').classList.add('hidden');
      document.getElementById('view-topic-section').classList.remove('hidden');
      document.getElementById('create-post-section').classList.remove('hidden');
      document.getElementById('post-error').classList.add('hidden');

      const topic = topics.find(t => t.id === topicId);
      if(!topic) {
        alert('Тема не найдена.');
        showTopicsList();
        return;
      }
      document.getElementById('view-topic-title').textContent = topic.title;
      renderPosts(topicId);
    }

    // === Обработчики ===

    // Регистрация
    document.getElementById('register-btn').onclick = () => {
      const username = document.getElementById('username-input').value.trim();
      const password = document.getElementById('password-input').value;
      const errorDiv = document.getElementById('auth-error');
      errorDiv.classList.add('hidden');
      errorDiv.textContent = '';

      if(username.length < 3) {
        errorDiv.textContent = 'Имя пользователя должно быть не менее 3 символов.';
        errorDiv.classList.remove('hidden');
        return;
      }
      if(password.length < 6) {
        errorDiv.textContent = 'Пароль должен быть не менее 6 символов.';
        errorDiv.classList.remove('hidden');
        return;
      }

      if(addUser(username, password)) {
        alert('Регистрация успешна! Теперь войдите в систему.');
        // очистить поля
        document.getElementById('username-input').value = '';
        document.getElementById('password-input').value = '';
      } else {
        errorDiv.textContent = 'Пользователь с таким именем уже существует.';
        errorDiv.classList.remove('hidden');
      }
    };

    // Вход
    document.getElementById('login-btn').onclick = () => {
      const username = document.getElementById('username-input').value.trim();
      const password = document.getElementById('password-input').value;
      const errorDiv = document.getElementById('auth-error');
      errorDiv.classList.add('hidden');
      errorDiv.textContent = '';

      if(!username || !password) {
        errorDiv.textContent = 'Введите имя пользователя и пароль.';
        errorDiv.classList.remove('hidden');
        return;
      }

      if(checkPassword(username, password)) {
        currentUser = getUsers().find(u => u.username.toLowerCase() === username.toLowerCase());
        saveSession(currentUser);
        updateUI();
      } else {
        errorDiv.textContent = 'Неверное имя пользователя или пароль.';
        errorDiv.classList.remove('hidden');
      }
    };

    // Выход
    document.getElementById('logout-btn').onclick = () => {
      clearSession();
      currentUser = null;
      updateUI();
    };

    // Создание темы
    document.getElementById('create-topic-btn').onclick = () => {
      const title = document.getElementById('topic-title-input').value.trim();
      const content = document.getElementById('topic-content-input').value.trim();
      const errorDiv = document.getElementById('topic-error');
      errorDiv.classList.add('hidden');
      errorDiv.textContent = '';

      if(title.length < 5) {
        errorDiv.textContent = 'Заголовок темы должен быть не менее 5 символов.';
        errorDiv.classList.remove('hidden');
        return;
      }
      if(content.length < 5) {
        errorDiv.textContent = 'Сообщение должно быть не менее 5 символов.';
        errorDiv.classList.remove('hidden');
        return;
      }
      // Создаем тему
      const topicId = 'topic_' + Date.now();
      const newTopic = {
        id: topicId,
        title,
        author: currentUser.username,
        date: new Date().toISOString()
      };
      topics.push(newTopic);
      saveTopics(topics);

      // Создаем первый пост темы
      const newPost = {
        id: 'post_' + Date.now(),
        topicId,
        author: currentUser.username,
        content,
        date: new Date().toISOString()
      };
      posts.push(newPost);
      savePosts(posts);

      // Очистка полей
      document.getElementById('topic-title-input').value = '';
      document.getElementById('topic-content-input').value = '';

      alert('Тема создана!');
      showTopic(topicId);
    };

    // Возврат к списку тем
    document.getElementById('back-to-topics-btn').onclick = () => {
      showTopicsList();
    };

    // Создание поста
    document.getElementById('create-post-btn').onclick = () => {
      const content = document.getElementById('post-content-input').value.trim();
      const errorDiv = document.getElementById('post-error');
      errorDiv.classList.add('hidden');
      errorDiv.textContent = '';

      if(content.length < 1) {
        errorDiv.textContent = 'Сообщение не может быть пустым.';
        errorDiv.classList.remove('hidden');
        return;
      }
      if(!currentTopicId) {
        alert('Тема не выбрана.');
        return;
      }

      const newPost = {
        id: 'post_' + Date.now(),
        topicId: currentTopicId,
        author: currentUser.username,
        content,
        date: new Date().toISOString()
      };
      posts.push(newPost);
      savePosts(posts);

      // Очистить поле ввода и обновить посты
      document.getElementById('post-content-input').value = '';
      renderPosts(currentTopicId);
    };

    // === Инициализация ===

    function init() {
      initAdmin();
      topics = getTopics();
      posts = getPosts();
      currentUser = loadSession();
      updateUI();
    }

    window.onload = init;
  </script>
</body>
</html>
