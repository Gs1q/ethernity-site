<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ethernity Games</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header>
    <img src="ethernity-logo.png" alt="Ethernity Logo" class="logo" />
    <nav class="header-right">
      <button onclick="location.href='servers.html'" class="nav-btn">Серверы</button>
      <button onclick="location.href='news.html'" class="nav-btn">Новости</button>
      <button onclick="location.href='forum.html'" class="nav-btn">Форум</button>
      <button id="discord-login" class="nav-btn highlight">Войти через Discord</button>
    </nav>
  </header>

  <main>
    <h1>Добро пожаловать в <span class="highlight">Ethernity Games</span></h1>
    <p>Игровые серверы по DayZ, Garry's Mod и Squad</p>
    <div class="hero-buttons">
      <button onclick="location.href='servers.html'" class="cta-btn">Список серверов</button>
      <button onclick="location.href='news.html'" class="cta-btn">Читать новости</button>
      <button onclick="location.href='forum.html'" class="cta-btn">Перейти на форум</button>
    </div>
  </main>

  <footer>
    <p>© 2025 Ethernity Games. Все права защищены.</p>
    <iframe src="https://discord.com/widget?id=1080748181752651776&theme=dark" width="350" height="500" allowtransparency="true" frameborder="0" sandbox="allow-popups allow-popups-to-escape-sandbox allow-same-origin allow-scripts"></iframe>
  </footer>

  <script>
    const clientId = "1395303543832969337";
    const redirectUri = encodeURIComponent("https://ethernity.vercel.app/");

    function saveToken(token) {
      sessionStorage.setItem("discord_token", token);
    }

    function getToken() {
      return sessionStorage.getItem("discord_token");
    }

    function clearToken() {
      sessionStorage.removeItem("discord_token");
    }

    function showProfile(user) {
      const loginBtn = document.getElementById("discord-login");
      loginBtn.style.display = "none";

      const profile = document.createElement("div");
      profile.className = "profile-menu";
      profile.innerHTML = `
        <img src="https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png" />
        <span>${user.username}#${user.discriminator}</span>
        <div class="dropdown">
          <a href="#" id="settings">Настройки</a>
          <a href="#" id="logout">Выйти</a>
        </div>
      `;
      document.querySelector(".header-right").appendChild(profile);

      profile.addEventListener("click", () => {
        const dropdown = profile.querySelector(".dropdown");
        dropdown.style.display = dropdown.style.display === "block" ? "none" : "block";
      });

      document.getElementById("logout").onclick = () => {
        clearToken();
        location.reload();
      };
    }

    async function fetchUser(token) {
      try {
        const res = await fetch("https://discord.com/api/users/@me", {
          headers: { Authorization: `Bearer ${token}` }
        });
        if (!res.ok) throw new Error();
        return await res.json();
      } catch {
        clearToken();
        return null;
      }
    }

    function login() {
      const scope = "identify";
      const discordUrl = `https://discord.com/oauth2/authorize?client_id=${clientId}&redirect_uri=${redirectUri}&response_type=token&scope=${scope}`;
      window.location.href = discordUrl;
    }

    function parseTokenFromUrl() {
      if (window.location.hash) {
        const params = new URLSearchParams(window.location.hash.slice(1));
        const token = params.get("access_token");
        if (token) {
          saveToken(token);
          window.history.replaceState({}, "", window.location.pathname);
          return true;
        }
      }
      return false;
    }

    document.getElementById("discord-login").addEventListener("click", login);

    (async () => {
      if (parseTokenFromUrl()) {
        const user = await fetchUser(getToken());
        if (user) showProfile(user);
      } else {
        const user = await fetchUser(getToken());
        if (user) showProfile(user);
      }
    })();
  </script>
</body>
</html>
